name: release

on:
  push:
    branches:
      - "master"

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  upload-conda:
    name: Upload packages to Conda
    permissions:
      id-token: write
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Install the latest Wasmer version
        uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
        with:
          repo: prefix-dev/rattler-build
          tag: "v0.41.0"

      - run: |
          rattler-build build \
            --wrap-log-lines=false \
            --log-style=plain \
            --skip-existing=all \
            --output-dir=./output \
            --channel=https://repo.prefix.dev/bit-torrent \
            --verbose \
            --recipe-dir=packages/libtorrent-static
        shell: bash
      - run: |
          find ./output/ -type f -name 'libtorrent-static-*.conda' | xargs rattler-build upload prefix -c bit-torrent

      - run: sleep 60

      - run: rm output -rf

      - run: |
          rattler-build build \
            --wrap-log-lines=false \
            --log-style=plain \
            --skip-existing=all \
            --output-dir=./output \
            --channel=https://repo.prefix.dev/bit-torrent \
            --verbose \
            --recipe-dir=recipe

      - run: |
          find ./output/ -type f -name 'qbittorrent-nox-*.conda' | xargs rattler-build upload prefix -c bit-torrent
